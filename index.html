<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bob's room</title>
  <style>
    :root{
      --bg:#f4f5f7;
      --panel:#ffffff;
      --panel2:#f8fafc;
      --text:#0f172a;
      --muted:#475569;
      --accent:#7c3aed;
      --accent2:#16a34a;
      --danger:#ef4444;
      --shadow: 0 14px 40px rgba(15,23,42,.12);
      --radius:18px;
      --border: rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 18% 0%, rgba(124,58,237,.14) 0%, rgba(124,58,237,0) 55%),
        radial-gradient(900px 600px at 95% 15%, rgba(34,197,94,.12) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, #f7f8fb 0%, var(--bg) 55%, #eef0f4 100%);
      color:var(--text);
      overflow-x:hidden;
      font-size: 16px;
    }
    .app{
      height:100vh;
      min-height:100%;
      padding: clamp(10px, 2.2vw, 18px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    header{
      flex:0 0 auto;
      display:flex;
      gap:12px;
      align-items:stretch;
      flex-wrap:wrap;
      margin-top: -16px;
    }
    .titlebar{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .titlebar h1{
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      text-align: center;
    }
    /* Keep the music pill pinned to the right */
    .titlebar .pillrow{
      margin-left: auto;
    }
    .title{
      font-weight: 800;
      letter-spacing: .2px;
      color:#993333;
    }

    .bob .b1{ color: #f97316; } /* warm orange */
    .bob .o { color: #22c55e; } /* friendly green */
    .bob .b2{ color: #3b82f6; } /* soft blue */

    .title .apos{ color: rgba(15,23,42,.55); }

    h1{
      margin:0;
      font-weight:900;
      font-size: clamp(20px, 3vw, 34px);
      letter-spacing:.2px;
    }
    .pillrow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      background: rgba(255,255,255,.7);
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 10px 25px rgba(15,23,42,.08);
      backdrop-filter: blur(10px);
    }
    .pill button{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      color:var(--text);
      border-radius:999px;
      padding: 6px 10px;
      font-weight:800;
      cursor:pointer;
    }
    .pill button:active{transform: translateY(1px)}
    .pill small{color:var(--muted); font-weight:700; font-size: 16px;}

    .msgcol{
      display:flex;
      min-height:0;
      flex-direction:column;
      gap:10px;
      flex:1 1 420px;
      min-width: 280px;
      max-width: 720px;
    }
    .box{
      background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(255,255,255,.72));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }
    .box.small{
      font-size: clamp(16px, 1.7vw, 18px);
      font-weight: 950;
    }
    .box.big{
      font-size: clamp(17px, 2.2vw, 20px);
      font-weight: 950;
      letter-spacing:.2px;
    }

    .main{
      display:flex;
      gap:12px;
      flex:1 1 auto;
      align-items:stretch;
      min-height: 420px;
    }
    .sceneWrap{
      flex: 1 1 68%;
      min-height:0;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      position:relative;
      overflow:hidden;
      min-height: 330px;
    }
    .options{
      flex: 0 0 340px;
      min-height:0;
      max-width: 380px;
      min-width: 280px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .optHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,23,42,.03);
      border: 1px solid rgba(15,23,42,.08);
    }
    .optHeader strong{font-size:16px}
    .optHeader span{color:var(--muted); font-weight:800; font-size:16px}
    .optList{
      overflow:auto;
      padding: 4px;
      margin:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      scrollbar-width: thin;
      flex:1 1 auto;
      min-height:0;
}

    .optBtn{
      width:100%;
      text-align:left;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
      color:var(--text);
      padding: 10px 10px;
      border-radius: 14px;
      cursor:pointer;
      line-height:1.2;
      font-weight: 850;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .optBtn:hover{background: rgba(15,23,42,.04)}
    .optBtn:active{transform: translateY(1px)}
    .badge{
      flex: 0 0 auto;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      font-weight: 950;
      background: rgba(124,58,237,.12);
      border: 1px solid rgba(124,58,237,.35);
      color: #4c1d95;
    }
    .optText{flex:1 1 auto; padding-top: 2px; font-size: 16px;}
    .footer{
      position:absolute;
      left: 10px;
      bottom: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .counter{
      pointer-events:auto;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(15,23,42,.10);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      box-shadow: 0 10px 25px rgba(15,23,42,.10);
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(780px, 100%);
      background: rgba(255,255,255,1);
      border: 1px solid rgba(15,23,42,.12);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: 0 25px 80px rgba(15,23,42,.35);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: rgba(15,23,42,.03);
      border-bottom: 1px solid rgba(15,23,42,.10);
    }
    .modalTop strong{font-size:16px}
    .modalTop button{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      color:var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
    }
    .modalBody{
      padding: 14px;
    }
    .dialogText{
      white-space: pre-wrap;
      line-height: 1.28;
      font-size: clamp(16px, 2.05vw, 18px);
      font-weight: 780;
      color: var(--text);
    }
    /* Invisible until we add .hl-on */
    .dialogText .hl-target{
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

    /* Only becomes “highlighted” during the 2s window */
    .dialogText .hl-target.hl-on{
      font-size: 115%;
      padding: 0 .25em;
      border-radius: .35em;
      box-shadow: 0 0 0 2px rgba(22,163,74,0.6) inset;
      background: rgba(22,163,74,0.2);
    }
    @keyframes pulse{
      from{filter:brightness(1)}
      to{filter:brightness(1.15)}
    }
    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      padding: 12px 14px 14px;
      flex-wrap:wrap;
    }
    .btn{
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(15,23,42,.03);
      color:var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      min-width: 110px;
      text-align:center;
      user-select:none;
    }
    .btn:hover{background: rgba(15,23,42,.05)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: rgba(22,163,74,.12);
      border-color: rgba(22,163,74,.35);
    }
    .btn.danger{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.35);
    }

    /* Used / disabled options */
    .optBtn.used,
    .optBtn:disabled{
      opacity: .45;
      filter: grayscale(1);
      cursor: not-allowed;
      transform: none;                 /* avoid "pressed" feel */
    }

    /* Prevent hover styling from making it look active */
    .optBtn.used:hover,
    .optBtn:disabled:hover{
      background: rgba(15,23,42,.02);
    }

    /* Optional: gray out the badge too */
    .optBtn.used .badge,
    .optBtn:disabled .badge{
      background: rgba(15,23,42,.08);
      border-color: rgba(15,23,42,.18);
      color: rgba(15,23,42,.55);
    }

    /* Scene */
    #scene{
      width:100%;
      height:100%;
      display:block;
      border-radius: calc(var(--radius) - 6px);
      background: radial-gradient(900px 380px at 30% 10%, rgba(255,255,255,.6) 0%, rgba(255,255,255,.1) 45%, rgba(0,0,0,0) 70%);
    }
    .hidden{display:none}

    .aboutText{
      font-size:16px;
      line-height:1.5;
    }
    .aboutText p{ margin:.35em 0; }
    .aboutText a{
      text-decoration: underline;
      font-weight: 800;
    }

    .pill select{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 800;
      cursor: pointer;
      font-size: 16px;
    }

    @media (max-width: 860px){
      .app{padding: 10px;}
      header{gap:10px;}
      .box{padding: 10px 12px;}
      .box.small{font-size: 16px;}
      .box.big{font-size: 17px;}
      .main{flex-direction:column; gap:10px; min-height:0;}
      .sceneWrap{
        height: 44vh;
        min-height: 220px;
      }
      .options{
        max-width:none;
        flex: 1 1 auto;
        min-height: 200px;
      }
      .titlebar h1 {
        left: 0px;
        position: relative;
        transform: none;
      }
    }
    @media (max-height: 400px){
      .modal{
        max-height: 350px;
        display: flex;
        flex-direction: column;
      }
      .modalBody{
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        flex: 1 1 auto;
        min-height: 0;
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="titlebar">
      <h1 class="title">
        <span class="bob"><span class="b1">B</span><span class="o">o</span><span class="b2">b</span></span><span class="apos">'s</span> room
      </h1>
      <div class="pillrow">
        <div class="pill" aria-label="Controls">
          <small id="musicLabel">Music</small>
          <button id="musicBtn" type="button" aria-pressed="false">Off</button>
          <button id="aboutBtn" type="button">About</button>
          <select id="langSel" aria-label="Language">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="it">Italiano</option>
            <option value="hu">Magyar</option>
          </select>
        </div>
      </div>
    </div>

    <header>
      <div class="msgcol">
        <div class="box small" id="introSmall">Bob is an organized person who likes simplicity.</div>
        <div class="box big" id="introBig">How can you improve Bob's room?</div>
      </div>
    </header>

    <div class="main">
      <div class="sceneWrap">
        <svg id="scene" viewBox="0 0 1024 450" role="img" aria-label="Bob's room scene">
      
          <defs>
            <!-- Light interior -->
            <linearGradient id="wall" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#ffffff" />
              <stop offset="1" stop-color="#e9edf2" />
            </linearGradient>
      
            <linearGradient id="floor" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#d9b891" />
              <stop offset="1" stop-color="#b9875d" />
            </linearGradient>
      
            <linearGradient id="woodEdge" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#b9855a" />
              <stop offset="1" stop-color="#8b5a3c" />
            </linearGradient>
          </defs>
      
          <!-- Room shell -->
          <rect x="0" y="0" width="1024" height="320" fill="url(#wall)" />
          <rect x="0" y="300" width="1024" height="150" fill="url(#floor)" />
          <path d="M0,300 L1024,300" stroke="rgba(15,23,42,.12)" stroke-width="2" />
      
          <!-- Subtle floor boards -->
          <g opacity=".18">
            <path d="M40 300 L0 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M140 300 L90 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M240 300 L190 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M340 300 L300 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M440 300 L420 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M540 300 L540 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M640 300 L660 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M740 300 L780 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M840 300 L900 450" stroke="#7a4f34" stroke-width="2" />
            <path d="M940 300 L1024 450" stroke="#7a4f34" stroke-width="2" />
          </g>

          <!-- Dust (sweep – wide scatter + some rotation) -->
          <g id="dust" transform="translate(20 300)" opacity="0.5">

            <!-- left -->
            <polygon points="20,34 38,24 54,34 34,44" fill="#cbd5e1"/>
            <g transform="translate(110 40) rotate(-18) scale(1 .95)">
              <polygon points="0,16 16,6 30,16 14,26" fill="#e2e8f0"/>
            </g>

            <!-- left-mid -->
            <g transform="translate(190 88) rotate(12) scale(.95 1)">
              <polygon points="0,18 20,8 38,18 18,30" fill="#b9c5d3"/>
            </g>
            <polygon points="260,58 278,50 294,58 276,66" fill="#cbd5e1"/>

            <!-- center -->
            <g transform="translate(380 78) rotate(-10)">
              <polygon points="0,20 20,10 40,20 18,34" fill="#e2e8f0"/>
            </g>
            <polygon points="460,54 478,46 494,54 476,62" fill="#cbd5e1"/>

            <!-- mid-right -->
            <g transform="translate(560 110) rotate(16) scale(1 .9)">
              <polygon points="0,18 22,8 44,18 22,32" fill="#b9c5d3"/>
            </g>
            <polygon points="650,72 670,64 688,72 666,82" fill="#e2e8f0"/>

            <!-- right -->
            <g transform="translate(760 115) rotate(-14)">
              <polygon points="0,18 22,8 44,18 20,34" fill="#cbd5e1"/>
            </g>
            <polygon points="840,88 860,80 878,88 856,98" fill="#b9c5d3"/>

            <!-- far right (near 1000) -->
            <g transform="translate(920 62) rotate(9) scale(.95 1)">
              <polygon points="0,16 18,8 36,16 18,26" fill="#e2e8f0"/>
            </g>
            <g transform="translate(970 126) rotate(-20) scale(1 .92)">
              <polygon points="0,18 22,10 42,18 20,32" fill="#cbd5e1"/>
            </g>

          </g>

          <!-- Window -->
          <g id="windowGroup" transform="translate(475 42)">

            <!-- Outer frame -->
            <polygon points="0,0 230,0 230,150 0,150"
                    fill="#ffffff" stroke="rgba(15,23,42,.18)" stroke-width="2.5"/>

            <!-- Single inner glass (fills the frame evenly; no levitation) -->
            <polygon id="windowGlass"
                    points="9,8 222,8 222,141 9,141"
                    fill="rgba(56,189,248,.18)"
                    stroke="rgba(15,23,42,.16)" stroke-width="2"/>

            <!-- Outside: sky + distant trees (aligned to the new glass bounds) -->
            <g id="outsideSky">
              <polygon points="10,10 220,10 220,74 10,74" fill="rgba(56,189,248,.22)"/>
              <polygon points="10,74 220,74 220,140 10,140" fill="rgba(34,197,94,.12)"/>
              <polygon points="10,122 72,92 122,130 170,104 220,124 220,140 10,140" fill="rgba(22,163,74,.18)"/>
              <polygon points="34,118 54,92 78,120" fill="rgba(15,118,110,.22)"/>
              <polygon points="126,124 148,92 170,126" fill="rgba(15,118,110,.22)"/>
              <polygon points="188,126 204,98 220,128" fill="rgba(15,118,110,.22)"/>
            </g>

            <!-- Subtle glass highlight (optional but helps it feel “in” the frame) -->
            <polygon points="140,10 220,10 220,60 165,74"
                    fill="rgba(255,255,255,.10)"/>

            <!-- Zipline anchor (still available) -->
            <!-- Local: (220, 26)  Global: (695, 68) -->
            <circle id="ziplineAnchor" cx="220" cy="26" r="3" fill="rgba(15,23,42,.35)"/>

            <!-- Curtain rod -->
            <path d="M0 8 L230 8" stroke="rgba(15,23,42,.22)" stroke-width="6" stroke-linecap="round"/>
            <circle cx="0" cy="8" r="5" fill="rgba(15,23,42,.22)"/>
            <circle cx="230" cy="8" r="5" fill="rgba(15,23,42,.22)"/>

            <!-- Curtains (unchanged) -->
            <g id="curtainOldOpen">
              <polygon points="172,8 230,8 230,154 190,154" fill="#fbbf24" stroke="#d97706" stroke-width="2"/>
              <polygon points="175,22 230,28 230,154 191,154" fill="#fde68a"/>
              <polygon points="206,88 216,82 224,92 216,102 208,98" fill="rgba(15,23,42,.22)" stroke="rgba(15,23,42,.12)" stroke-width="1"/>
            </g>

            <g id="curtainOldClosed" class="hidden">
              <polygon points="0,8 230,8 230,154 0,154" fill="#fbbf24" stroke="#d97706" stroke-width="2"/>
              <polygon points="0,10 50,22 102,10 158,24 230,10 230,154 0,154" fill="#fde68a"/>
              <polygon points="106,84 124,76 134,90 124,104 110,100" fill="rgba(15,23,42,.22)" stroke="rgba(15,23,42,.12)" stroke-width="1"/>
            </g>

            <g id="curtainNewOpen" class="hidden">
              <polygon points="172,8 230,8 230,154 190,154" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
              <polygon points="175,22 230,28 230,154 191,154" fill="#c7d2fe"/>
              <path d="M194 22 L216 154" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
              <path d="M206 20 L226 154" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            </g>

            <g id="curtainNewClosed" class="hidden">
              <polygon points="0,8 230,8 230,154 0,154" fill="#818cf8" stroke="#4f46e5" stroke-width="2"/>
              <polygon points="0,10 50,22 102,10 158,24 230,10 230,154 0,154" fill="#c7d2fe"/>
              <path d="M16 14 L42 154" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
              <path d="M62 14 L88 154" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
              <path d="M110 14 L136 154" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
              <path d="M158 14 L184 154" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            </g>

          </g>

          <!-- Flowers (inside window, scaled & positioned) -->
          <g id="flowers"
            class="hidden"
            transform="translate(545 105) scale(0.65)">

            <!-- pot -->
            <polygon points="28,92 102,92 92,132 38,132"
                    fill="#C66A5A"
                    stroke="rgba(15,23,42,.18)"
                    stroke-width="2"/>

            <!-- stems -->
            <polygon points="44,92 62,48 68,52 52,92"
                    fill="#22c55e"
                    stroke="rgba(15,23,42,.16)"
                    stroke-width="2"/>

            <polygon points="70,92 92,52 98,56 78,92"
                    fill="#16a34a"
                    stroke="rgba(15,23,42,.16)"
                    stroke-width="2"/>

            <!-- blooms -->
            <polygon points="62,50 78,38 90,52 76,64"
                    fill="#fbbf24"
                    stroke="rgba(15,23,42,.12)"
                    stroke-width="2"/>

            <polygon points="78,38 104,40 110,58 90,52"
                    fill="#fb7185"
                    stroke="rgba(15,23,42,.12)"
                    stroke-width="2"/>

            <polygon points="74,70 94,58 106,74 92,86"
                    fill="#60a5fa"
                    stroke="rgba(15,23,42,.12)"
                    stroke-width="2"/>
          </g>

          <!-- Simple low-poly table (left-side room view) -->
          <g id="table1" transform="translate(100 210) scale(1 1.2)">

            <!-- Table top -->
            <polygon
              points="40,40 210,40 190,70 20,70"
              fill="#c08b5a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

            <!-- Top highlight (RIGHT side) -->
            <polygon
              points="160,40 210,40 190,70 120,70"
              fill="rgba(255,255,255,.12)"/>

            <!-- Back left leg (slightly darker) -->
            <polygon
              points="42,70 56,70 54,140 44,140"
              fill="#844d2f"/>

            <!-- Back right leg (slightly darker) -->
            <polygon
              points="190,70 204,48 202,120 192,120"
              fill="#844d2f"/>

            <!-- Front left leg -->
            <polygon
              points="30,70 48,70 45,150 33,150"
              fill="#9a5d3a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

            <!-- Front right leg -->
            <polygon
              points="165,70 183,70 180,150 168,150"
              fill="#9a5d3a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

          </g>

          <!-- Extra table (hidden until added) -->
          <g id="table2" class="hidden" transform="translate(290 210) scale(1 1.2)">

            <!-- Table top -->
            <polygon
              points="40,40 210,40 190,70 20,70"
              fill="#c08b5a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

            <!-- Top highlight (RIGHT side) -->
            <polygon
              points="160,40 210,40 190,70 120,70"
              fill="rgba(255,255,255,.12)"/>

            <!-- Back left leg (slightly darker) -->
            <polygon
              points="42,70 56,70 54,140 44,140"
              fill="#844d2f"/>

            <!-- Back right leg (slightly darker) -->
            <polygon
              points="190,70 204,48 202,120 192,120"
              fill="#844d2f"/>

            <!-- Front left leg -->
            <polygon
              points="30,70 48,70 45,150 33,150"
              fill="#9a5d3a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

            <!-- Front right leg -->
            <polygon
              points="165,70 183,70 180,150 168,150"
              fill="#9a5d3a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

          </g>

          <!-- Backpack (leaning / against table) -->
          <g id="backpackLean" transform="translate(80 316) scale(0.75)">

            <!-- main body -->
            <polygon points="20,12 56,0 92,12 104,46 90,104 26,104 10,46"
                    fill="#bb4442" stroke="rgba(15,23,42,.18)" stroke-width="2"/>

            <!-- side gusset (depth) -->
            <polygon points="92,12 104,46 90,104 80,104 90,48 82,16"
                    fill="#ee4442" stroke="rgba(15,23,42,.12)" stroke-width="1.5"/>

            <!-- top flap -->
            <polygon points="28,18 56,6 84,18 78,30 34,30"
                    fill="#069906" stroke="rgba(15,23,42,1)" stroke-width="1.5" opacity="0.35"/>

            <!-- front pocket -->
            <polygon points="30,58 78,58 84,74 74,98 34,98 24,74"
                    fill="#005500" stroke="rgba(15,23,42,1)" stroke-width="1.5" opacity="0.35"/>

            <!-- zipper line -->
            <path d="M30 58 L78 58"
                  stroke="rgba(15,23,42,.5)" stroke-width="2" stroke-linecap="round"/>

            <!-- handle -->
            <path d="M48 14 C52 8, 60 8, 64 14"
                  stroke="rgba(15,23,180,1)" stroke-width="4" fill="none" stroke-linecap="round"/>

          </g>
          <!-- Backpack (on table) -->
          <g id="backpackOnTable" class="hidden" transform="translate(215 225) scale(0.75)">

            <!-- main body -->
            <polygon points="14,10 42,0 76,10 88,34 78,74 22,74 6,34"
                    fill="#bb4442" stroke="rgba(15,23,42,.18)" stroke-width="2"/>

            <!-- side gusset (depth) -->
            <polygon points="76,10 88,34 78,74 70,74 78,36 70,14"
                    fill="#ee4442" stroke="rgba(15,23,42,.12)" stroke-width="1.5"/>

            <!-- top flap -->
            <polygon points="18,14 42,6 72,14 66,24 24,24"
                    fill="#069906" stroke="rgba(15,23,42,1)" stroke-width="1.5" opacity="0.35"/>

            <!-- front pocket -->
            <polygon points="22,40 66,40 72,54 64,70 26,70 18,54"
                    fill="#005500" stroke="rgba(15,23,42,1)" stroke-width="1.5" opacity="0.35"/>

            <!-- zipper line -->
            <path d="M22 40 L66 40"
                  stroke="rgba(15,23,42,.5)" stroke-width="2" stroke-linecap="round"/>

            <!-- handle -->
            <path d="M38 12 C42 7, 50 7, 54 12"
                  stroke="rgba(15,23,180,1)" stroke-width="4" fill="none" stroke-linecap="round"/>
          </g>

          <!-- Papers on floor -->
          <g id="papers" transform="translate(230 360)">
            <polygon points="0,30 55,0 55,18 34,48" fill="#ffffff" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
            <path d="M8 30 L55 5" stroke="rgba(15,23,42,.16)" stroke-width="2" />
            <path d="M17 34 L55 8" stroke="rgba(15,23,42,.12)" stroke-width="2" />
            <path d="M25 40 L55 10" stroke="rgba(15,23,42,.12)" stroke-width="2" />
            <polygon points="92,18 126,6 158,30 118,50" fill="#f8fafc" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
            <path d="M98 20 L128 10" stroke="rgba(15,23,42,.14)" stroke-width="2" />
            <path d="M102 25 L134 14" stroke="rgba(15,23,42,.14)" stroke-width="2" />
            <path d="M105 30 L138 18" stroke="rgba(15,23,42,.14)" stroke-width="2" />
            <path d="M109 35 L120 31" stroke="rgba(15,23,42,.14)" stroke-width="2" />
            <polygon points="30,58 74,40 116,62 64,82" fill="#f8fafc" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
            <path d="M40 60 L76 45" stroke="rgba(15,23,42,.12)" stroke-width="2" />
            <path d="M46 63 L82 48" stroke="rgba(15,23,42,.12)" stroke-width="2" />
          </g>

          <!-- Bed group -->
          <g id="bedRig" transform="translate(400 240)">

            <!-- Legs (table-style: inset, narrow, back legs darker/shorter) -->
            <!-- back-left -->
            <polygon points="-4,81 10,81 8,131 -2,131" fill="#844d2f"/>

            <!-- back-right-->
            <polygon points="216,81 230,81 228,131 218,131" fill="#844d2f"/>

            <!-- front-left -->
            <polygon points="28,112 46,112 44,172 30,172"
                    fill="#9a5d3a"
                    stroke="rgba(15,23,42,.18)"
                    stroke-width="2"/>

            <!-- front-right -->
            <polygon points="248,112 266,112 264,172 250,172"
                    fill="#9a5d3a"
                    stroke="rgba(15,23,42,.18)"
                    stroke-width="2"/>

            <!-- Frame (wood) -->
            <polygon points="-14,68 242,68 278,112 22,112"
              fill="#c08b5a"
              stroke="rgba(15,23,42,.18)"
              stroke-width="2"/>

            <!-- Headboard (wood) -->
            <g id="headboard3d">
              <!-- top face -->
              <polygon points="-17,56 -9,56 22,96 7,96"
                      fill="#c08b5a" stroke="rgba(15,23,42,.18)" stroke-width="2"/>

              <!-- front face -->
              <polygon points="10,96 22,96 22,114 9,114"
                      fill="#b9855a" stroke="rgba(15,23,42,.18)" stroke-width="2"/>

              <!-- side face (left) -->
              <polygon points="-17,56 -17,74 10,114 10,96"
                      fill="#8b5a3c" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
            </g>

            <!-- Mattress -->
            <g id="mattressNormal">
              <polygon points="10,50 245,50 265,82 30,82" fill="#ffffff" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
              <polygon points="30,82 265,82 265,102 30,102" fill="#e2e8f0" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
              <polygon points="10,50 10,70 30,102 30,82" fill="#e2e8f0" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
            </g>

            <g id="mattressSpine" class="hidden">
              <polygon points="10,50 245,50 265,82 30,82" fill="#dcfce7" stroke="rgba(15,23,42,.18)" stroke-width="2"/>
              <polygon points="30,82 265,82 265,102 30,102" fill="#bbf7d0" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
              <polygon points="10,50 10,70 30,102 30,82" fill="#bbf7d0" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
            </g>

            <!-- Blanket -->
            <g id="blanketUnfolded">
              <polygon points="70,50 235,50 253,80 80,80" fill="#fda4af" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
            </g>

            <g id="blanketFolded" class="hidden">
              <polygon points="200,50 235,50 253,80 210,80" fill="#fda4af" stroke="rgba(15,23,42,.14)" stroke-width="2"/>
            </g>

            <!-- Pillow -->
            <g id="pillowNormal">
              <polygon points="15,38 63,38 75,58 25,58" fill="#ffffff" stroke="rgba(15,23,42,.16)" stroke-width="2"/>
              <polygon points="25,58 75,58 73,72 29,72" fill="#e2e8f0" stroke="rgba(15,23,42,.12)" stroke-width="2"/>
              <polygon points="15,38 15,53 27,72 29,72 29,58" fill="#e2e8f0" stroke="rgba(15,23,42,.12)" stroke-width="2"/>
            </g>

            <g id="pillowFlipped" class="hidden">
              <polygon points="15,38 63,38 75,58 25,58" fill="#f8fafc" stroke="rgba(15,23,42,.16)" stroke-width="2"/>
              <polygon points="25,58 75,58 73,72 29,72" fill="#e2e8f0" stroke="rgba(15,23,42,.12)" stroke-width="2"/>
              <polygon points="15,38 15,53 27,72 29,72 29,58" fill="#e2e8f0" stroke="rgba(15,23,42,.12)" stroke-width="2"/>
              <polygon points="22,43 60,43 66,53 28,53" fill="#ccc"/>
            </g>

          </g>

        <div class="footer">
          <div class="counter" id="counter">0 improvements</div>
        </div>
      </div>

      <aside class="options" aria-label="Options list">
<ul class="optList" id="optList"></ul>
      </aside>
    </div>
  </div>

  <!-- Dialog -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalTop">
        <strong id="modalTitle">Mind</strong>
        <button id="closeModal" type="button" aria-label="Close dialog">✕</button>
      </div>
      <div class="modalBody">
        <div class="dialogText" id="dialogText"></div>
      </div>
      <div class="actions" id="dialogActions"></div>
    </div>
  </div>

  <!-- Credits popup -->
  <div class="overlay" id="aboutOverlay" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="modal">
      <div class="modalTop">
        <strong id="aboutTitle">About</strong>
        <button class="xbtn" id="closeAbout" type="button" aria-label="Close about">✕</button>
      </div>

      <div class="modalBody">
        <div class="aboutText">
          <p><strong><span id="aboutCreatorsLabel">Creators</span>:</strong> Swintleton</p>
          <p><strong><span id="aboutGithubLabel">GitHub</span>:</strong>
            <a href="https://github.com/Swintleton/Bobs-room" target="_blank" rel="noopener noreferrer">
              github.com/Swintleton/Bobs-room
            </a>
          </p>
          <p><strong><span id="aboutEmailLabel">Email</span>:</strong>
            <a href="mailto:keragon2@gmail.com">keragon2@gmail.com</a>
          </p>
          <p><strong><span id="aboutVersionLabel">Version</span>:</strong> 1.0.1</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="aboutOk" type="button">OK</button>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   State + utilities
----------------------------*/
const state = {
  score: 0,
  // visuals / flags
  papersRemoved: false,
  blanketFolded: false,
  curtainNew: false,

  // Curtain is open by default; option 4 closes it once.
  curtainClosed: false,
  windowOpen: false,

  extraTable: false,
  flowersAdded: false,
  mattressSpine: false,
  bedCorner: false,
  bedRotated: false,
  pillowFlipped: false,
  beddingRemoved: false,
  backpackOnTable: false,
  floorSwept: false,

  // per-run option usage
  usedOptions: {}, // { [optionId]: true }

  // music
  musicOn: false
};

const el = (id) => document.getElementById(id);

// --- i18n -------------------------------------------------
const I18N = {
  en: {
    ui: {
      music: "Music",
      about: "About",
      on: "On",
      off: "Off",
      introSmall: "Bob is an organized person who likes simplicity.",
      introBig: "How can you improve Bob's room?",
      improvements: { one: "improvement", many: "improvements" },

      aboutTitle: "About",
      creators: "Creators",
      github: "GitHub",
      email: "Email",
      version: "Version",
      ok: "OK",
      yes: "Yes",
      no: "No",
      evaluationTitle: "Evaluation",
      restartQ: "Restart?",
    },
    options: {
      1:"Clean up the trash papers from the floor.",
      2:"Fold the blanket.",
      3:"Replace the holey curtain with a new one.",
      4:"Close the curtain.",
      5:"Open the window.",
      6:"Add another table.",
      7:"Add flowers under the window.",
      8:"Add a spine friendly mattress.",
      9:"Move the bed to the corner.",
      10:"Rotate the bed.",
      11:"Flip the pillow.",
      12:"Wash the bedding.",
      13:"Give up.",
      14:"Put the backpack on the table.",
      15:"Sweep the floor.",
      16:"I'm done."
    }
  },

  es: {
    ui: {
      music: "Música",
      on: "On",
      off: "Off",
      about: "Acerca de",
      aboutTitle: "Acerca de",
      creators: "Creadores",
      github: "GitHub",
      email: "Email",
      introSmall: "Bob es una persona ordenada a la que le gusta la sencillez.",
      introBig: "¿Cómo puedes mejorar la habitación de Bob?",
      improvementsOne: "mejora",
      improvementsMany: "mejoras",
      evaluationTitle: "Evaluación",
      restartQ: "¿Reiniciar?",
      yes: "Sí",
      no: "No",
      ok: "OK"
    },
    options: {
      1: "Recoger los papeles arrugados del suelo.",
      2: "Doblar la manta.",
      3: "Reemplazar la cortina agujereada por una nueva.",
      4: "Cerrar la cortina.",
      5: "Abrir la ventana.",
      6: "Añadir otra mesa.",
      7: "Poner flores bajo la ventana.",
      8: "Cambiar el colchón por uno más firme (para la espalda).",
      9: "Mover la cama a la esquina.",
      10: "Girar la cama.",
      11: "Dar la vuelta a la almohada.",
      12: "Lavar la ropa de cama.",
      13: "Rendirse.",
      14: "Poner la mochila sobre la mesa.",
      15: "Barrer el suelo.",
      16: "He terminado."
    }
  },

  it: {
    ui: {
      music: "Musica",
      on: "On",
      off: "Off",
      about: "Info",
      aboutTitle: "Info",
      creators: "Creatori",
      github: "GitHub",
      email: "Email",
      introSmall: "Bob è una persona ordinata a cui piace la semplicità.",
      introBig: "Come puoi migliorare la stanza di Bob?",
      improvementsOne: "miglioria",
      improvementsMany: "migliorie",
      evaluationTitle: "Valutazione",
      restartQ: "Ricominciare?",
      yes: "Sì",
      no: "No",
      ok: "OK"
    },
    options: {
      1: "Raccogliere i fogli stropicciati dal pavimento.",
      2: "Piegare la coperta.",
      3: "Sostituire la tenda bucata con una nuova.",
      4: "Chiudere la tenda.",
      5: "Aprire la finestra.",
      6: "Aggiungere un altro tavolo.",
      7: "Mettere dei fiori sotto la finestra.",
      8: "Sostituire il materasso con uno più adatto alla schiena.",
      9: "Spostare il letto nell’angolo.",
      10: "Ruotare il letto.",
      11: "Girare il cuscino.",
      12: "Lavare la biancheria da letto.",
      13: "Arrendersi.",
      14: "Mettere lo zaino sul tavolo.",
      15: "Spazzare il pavimento.",
      16: "Ho finito."
    }
  },

  hu: {
    ui: {
      music: "Zene",
      about: "Névjegy",
      on: "Be",
      off: "Ki",
      introSmall: "Bob rendezett ember, aki szereti az egyszerűséget.",
      introBig: "Hogyan tudnád javítani Bob szobáját?",
      // Hungarian usually uses singular after numbers: "2 javítás"
      improvements: { one: "javítás", many: "javítás" },

      aboutTitle: "Névjegy",
      creators: "Készítők",
      github: "GitHub",
      email: "Email",
      version: "Verzió",
      ok: "OK",
      yes: "Igen",
      no: "Nem",
      evaluationTitle: "Értékelés",
      restartQ: "Újrakezdés?",
    },
    options: {
      1:"Szedjük fel a gyűrött papírokat a földről.",
      2:"Hajtsuk össze a takarót.",
      3:"Cseréljük le a lyukas függönyt egy újra.",
      4:"Húzzuk be a függönyt.",
      5:"Nyissuk ki az ablakot.",
      6:"Tegyünk be még egy asztalt.",
      7:"Tegyünk virágokat az ablak alá.",
      8:"Tegyünk be gerincbarát matracot.",
      9:"Tegyük az ágyat a sarokba.",
      10:"Fordítsuk meg az ágyat.",
      11:"Fordítsuk meg a párnát.",
      12:"Mossuk ki az ágyneműt.",
      13:"Feladom.",
      14:"Tegyük a hátizsákot az asztalra.",
      15:"Söpörjük fel a padlót.",
      16:"Kész vagyok."
    }
  }
};

state.lang = localStorage.getItem("lang") || "en";

function t(path){
  const langPack = I18N[state.lang] || I18N.en;
  const parts = path.split(".");
  let cur = langPack;
  for (const p of parts) cur = cur?.[p];
  // fallback to English if missing
  if (cur == null){
    cur = I18N.en;
    for (const p of parts) cur = cur?.[p];
  }
  return cur;
}

function optionLabel(id){
  return (I18N[state.lang]?.options?.[id]) ?? I18N.en.options[id] ?? `Option ${id}`;
}

function improvementWord(n){
  const imp = t("ui.improvements");
  return (n === 1) ? imp.one : imp.many;
}

function setMusicButtonText(){
  el("musicBtn").textContent = state.musicOn ? t("ui.on") : t("ui.off");
}

function applyLanguage(lang){
  state.lang = lang;
  localStorage.setItem("lang", lang);

  // top bar
  el("musicLabel").textContent = t("ui.music");
  el("aboutBtn").textContent   = t("ui.about");

  // header boxes
  el("introSmall").textContent = t("ui.introSmall");
  el("introBig").textContent   = t("ui.introBig");

  // about modal labels
  el("aboutTitle").textContent         = t("ui.aboutTitle");
  el("aboutCreatorsLabel").textContent = t("ui.creators");
  el("aboutGithubLabel").textContent   = t("ui.github");
  el("aboutEmailLabel").textContent    = t("ui.email");
  el("aboutVersionLabel").textContent  = t("ui.version");
  el("aboutOk").textContent            = t("ui.ok");

  // dynamic UI
  setMusicButtonText();
  setCounter();     // rebuilds "X improvements"
  renderOptions();  // rebuilds option labels
}

function pluralize(n, one, many){
  return n === 1 ? one : many;
}

function setCounter(){
  el("counter").textContent = `${state.score} ${improvementWord(state.score)}`;
  renderOptions();
}

function safeHtmlFromTokenText(text){
  const esc = (s) => s
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
  let out = esc(text);
  out = out
    .replaceAll("\\n", "\n")
    .replaceAll("[[H]]", `<span class="hl-target" data-hl="1">`)
    .replaceAll("[[/H]]", `</span>`);
  return out;
}

function awardPointOnce(optionId, flagName){
  if (!state[flagName]){
    state[flagName] = true;
    state.score += 1;
    markOptionUsed(optionId);
    setCounter();
    updateScene();
    return true;
  }
  return false;
}

function markOptionUsed(optionId){
  const opt = options.find(o => o.id === optionId);
  if (!opt?.once) return;
  state.usedOptions[optionId] = true;
  renderOptions(); // so it grays out immediately
}

/* ---------------------------
   Low-poly SVG toggles
----------------------------*/
function updateScene(){
  // Papers
  el("papers").classList.toggle("hidden", state.papersRemoved);

  // Dust
  el("dust").classList.toggle("hidden", state.floorSwept);

  // Blanket
  el("blanketUnfolded").classList.toggle("hidden", state.blanketFolded || state.beddingRemoved);
  el("blanketFolded").classList.toggle("hidden", !state.blanketFolded || state.beddingRemoved);

  // Mattress
  el("mattressNormal").classList.toggle("hidden", state.mattressSpine);
  el("mattressSpine").classList.toggle("hidden", !state.mattressSpine);

  // Pillow
  el("pillowNormal").classList.toggle("hidden", state.pillowFlipped || state.beddingRemoved);
  el("pillowFlipped").classList.toggle("hidden", !state.pillowFlipped || state.beddingRemoved);

  // Curtains: single curtain, open by default
  const useNew = state.curtainNew;
  const closed = state.curtainClosed;

  const windowOpen = state.windowOpen;

  // Old
  el("curtainOldOpen").classList.toggle("hidden", useNew || closed);
  el("curtainOldClosed").classList.toggle("hidden", useNew || !closed);

  // New
  el("curtainNewOpen").classList.toggle("hidden", !useNew || closed);
  el("curtainNewClosed").classList.toggle("hidden", !useNew || !closed);

  // Window open/closed glass shape
  const glass = el("windowGlass");
  if (glass){
    glass.setAttribute(
      "points",
      state.windowOpen
        ? "109,8 222,8 222,141 109,141" // open
        : "9,8 222,8 222,141 9,141"     // closed
    );
  }

  // Flowers
  el("flowers").classList.toggle("hidden", !state.flowersAdded);

  // Tables
  el("table2").classList.toggle("hidden", !state.extraTable);

  // Backpack
  el("backpackLean").classList.toggle("hidden", state.backpackOnTable);
  el("backpackOnTable").classList.toggle("hidden", !state.backpackOnTable);

  // Bed move/rotate
  const bed = el("bedRig");
  let x = 400, y = 240;
  if (state.bedCorner){
    x = 705; y = 240;
  }
  const sx = state.bedRotated ? -1 : 1;

  // Flip around the bed rig's horizontal center so it doesn't "jump" when moved.
  // bedRig local bounds are roughly x=-10..300, so center is ~145.
  const cx = 145;

  bed.setAttribute("transform", `translate(${x} ${y}) translate(${cx} 0) scale(${sx} 1) translate(${-cx} 0)`);
}

/* ---------------------------
   Options list
----------------------------*/
const options = [
  {id:1,  label:"Clean up the trash papers from the floor.", once:true},
  {id:2,  label:"Fold the blanket.", once:true},
  {id:3,  label:"Replace the holey curtain with a new one.", once:true},
  {id:4,  label:"Close the curtain.", once:true},
  {id:5,  label:"Open the window.", once:true},
  {id:6,  label:"Add another table.", once:true},
  {id:7,  label:"Add flowers under the window.", once:true},
  {id:8,  label:"Add a spine friendly mattress.", once:true},
  {id:9,  label:"Move the bed to the corner.", once:true},
  {id:10, label:"Rotate the bed.", once:true},
  {id:11, label:"Flip the pillow.", once:true},
  {id:12, label:"Wash the bedding.", once:true},
  {id:13, label:"Give up.", once:true},
  {id:14, label:"Put the backpack on the table.", once:true},
  {id:15, label:"Sweep the floor.", once:true},
  {id:16, label:"I'm done.", visible: () => state.score !== 0}
];

function renderOptions(){
  const list = el("optList");
  list.innerHTML = "";
  for (const opt of options){
    if (opt.visible && !opt.visible()) continue;
    const li = document.createElement("li");
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "optBtn";
    btn.dataset.option = String(opt.id);

    const alreadyUsed = !!state.usedOptions[opt.id];

    if (opt.once && alreadyUsed) {
      btn.disabled = true;              // prevents clicking
      btn.classList.add("used");        // for custom styling
    }

    const badge = document.createElement("span");
    badge.className = "badge";
    badge.textContent = String(opt.id);

    const text = document.createElement("span");
    text.className = "optText";
    text.textContent = optionLabel(opt.id);

    btn.appendChild(badge);
    btn.appendChild(text);
    btn.addEventListener("click", () => openDialogForOption(opt.id));

    li.appendChild(btn);
    list.appendChild(li);
  }
}

/* ---------------------------
   Dialog system
----------------------------*/
const overlay = el("overlay");
const dialogText = el("dialogText");
const actions = el("dialogActions");

let currentDialog = null;
let autoCloseTimer = null;

function closeDialog(){
  if (autoCloseTimer){
    clearTimeout(autoCloseTimer);
    autoCloseTimer = null;
  }
  overlay.classList.remove("show");
  currentDialog = null;
  dialogText.innerHTML = "";
  actions.innerHTML = "";
}

function showDialog(dialog){
  currentDialog = dialog;
  overlay.classList.add("show");
  goToNode("start");
}

function isPointAwardNode(node){
  return typeof node?.text === "string" && /\b1 point\b/i.test(node.text);
}

function nodeHasHighlight(node){
  return typeof node?.text === "string" && node.text.includes("[[H]]");
}

const DIALOG_TEXT = {
  es: {
  1: {
    start: `¿Crees que los papeles arrugados del suelo son basura?
¿Crees que Bob lo ve igual?

¿Deberíamos recogerlos?`,
    a: `Si los papeles del suelo fueran realmente basura, eso significaría que la habitación de Bob no está ordenada, porque tiene basura en el suelo.
En resumen: Bob no es ordenado si su habitación tiene basura por ahí.

¿Estás de acuerdo?`,
    b: `Pero sabemos con certeza que Bob es ordenado, ¿verdad?
En ese caso podemos concluir que los papeles del suelo no son basura.
Tiene que ser así, porque si no, la habitación no estaría ordenada, y por lo tanto Bob tampoco. Y eso no puede ser.
Así que ya sabemos que están ahí por una razón; quién sabe, quizá sean importantes.

¿Qué piensas?
¿Aun así los tirarías, aunque sepamos que están ahí a propósito?`,
    c: `¿Estás diciendo que Bob es ordenado cuando su habitación no lo es? — Qué raro.
Eso significa que los papeles están ahí por una razón.`,
    d: `Recuerda: estamos aquí para mejorar la habitación, y estamos a punto de tirar algo que sabemos que está ahí por una razón.

¿Tirar esto sería una mejora real?`,
    e: `Los papeles han desaparecido.\n1 punto`
  },

  2: {
    start: `¿Crees que Bob dejó la manta sin doblar por descuido?`,
    a: `Pero sabemos que Bob es ordenado, ¿verdad?
Entonces, ¿por qué dejaría la manta sin doblar?
No tiene sentido…
A menos que… ¡sea a propósito!
Vale: Bob la dejó así por una razón.

¿Deberíamos doblarla de todos modos?`,
    b: `Entonces, ¿por qué la doblarías?

¿Deberíamos dejarla tal como está?`,
    c: `O sea… ¿la doblamos sin ningún motivo?

¿La doblamos igualmente?`,
    done: `La manta arrugada es reemplazada por una doblada.\n1 punto`
  },

  3: {
    start: `Es raro que Bob haya dejado colgada una cortina tan vieja y agujereada, ¿no?

¿Crees que vale la pena pensarlo un poco?`,
    a: `De acuerdo.
¡Pongamos a trabajar los engranajes!

¿Por qué haría eso Bob?
¿Por qué dejaría una cortina tan vieja y agujereada ahí?

¿Crees que tenía un plan?
¿Crees que ya está en proceso de cambiarla él mismo por una nueva?
¿Crees que la cortina tiene algún valor sentimental para él?

¿Deberíamos reemplazarla a pesar de estas dudas?`,
    b: `De acuerdo.
¿Por qué perder tiempo con tonterías?
Al fin y al cabo, aquí mandamos nosotros.

¿Deberíamos reemplazar esa broma de cortina por una nueva y elegante?
Bob seguramente nos lo agradecerá, ¿no?`,
    done: `La vieja cortina agujereada es reemplazada por una nueva.\n1 punto`
  },

  4: {
    start: `¿Por qué dejaría la cortina abierta en un día así?
El sol está ardiendo, ¿no?
Es bastante obvio que hay que cerrar la cortina, ¿no?

¿Cerramos la cortina?`,
    a: `¿Cómo que no?
¿Por qué no?

¿Hay algo que debamos tener en cuenta?`,
    b: `¿Como qué?
¿Qué razón podría tener Bob para pensar que hoy la cortina debe estar abierta?

Tomemos aire y repasemos lo que sabemos antes de forzar nada.

Sabemos que Bob es ordenado, ¿verdad?
Eso podría ser una pista de que quizá dejó la cortina abierta por una razón, ¿no?

¿Corremos el riesgo y la cerramos aunque no sepamos por qué está abierta?`,
    c: `Entonces… ¡cerremos la cortina ya!`,
    done: `La cortina está cerrada.\n1 punto`
  },

  5: {
    start: `Qué raro.
La ventana está cerrada.
¿Por qué la dejaría cerrada en un día tan bonito?

¿La abrimos?
Eso suena como una mejora [[H]]para mí[[/H]].`,
    done: `Resalta el texto: "para mí" durante 2 segundos.\nLa ventana se abre.\n1 punto`
  },

  6: {
    start: `Esta habitación se siente bastante vacía [[H]]para mí[[/H]].

¿Por qué no añadimos otra mesa?
Seguro que Bob lo apreciaría.

¿Añadimos una mesa nueva a la habitación?`,
    done: `Resalta el texto: "para mí" durante 2 segundos.\nSe añade otra mesa a la habitación.\n1 punto`
  },

  7: {
    start: `¿Las flores?
Sí: faltan flores debajo de la ventana.

Bob debería saberlo, ¿no?`,
    a: `Sí, de verdad debería saber qué va debajo de la ventana.`,
    b: `¿No?
Entonces, ¿qué hacemos?

¿Añadimos las flores igualmente?`,
    done: `Se añade un jarrón con flores debajo de la ventana.\n1 punto`
  },

  8: {
    start: `¡Mira ese colchón!
Es demasiado blando para que una persona decente se acueste ahí, ¿no?

¿Lo cambiamos por uno mejor, más adecuado para la espalda?`,
    done: `El colchón es reemplazado.\n1 punto`
  },

  9: {
    start: `Esa cama de ahí…
Sí, esa.
Seguro que está fuera de lugar donde está ahora.
Moverla a la esquina es mucho más conveniente.

¿Movemos la cama a la esquina?`,
    done: `La cama se mueve a la esquina.\n1 punto`
  },

  10: {
    start: `Mira esa cama…
Está mirando hacia la dirección equivocada.

¿La giramos?`,
    done: `La cama se gira.\n1 punto`
  },

  11: {
    start: `Esa almohada…
Claramente está del lado equivocado, ¿no?

¿La damos la vuelta?`,
    done: `La almohada se da la vuelta.\n1 punto`
  },

  12: {
    start: `Esa ropa de cama…
Parece sucia.

¿La lavamos?`,
    done: `La ropa de cama se lava.\n1 punto`
  },

  13: {
  start: `Entonces… ¿no quieres mejorar nada?

¿Quieres rendirte?`,

  a: `¿Qué?
¡Pero mira su habitación, es un desastre!
¡Está claro que necesita nuestra ayuda!

Probemos un par de cosas antes de rendirnos, ¿vale?`,

  b: `¿De verdad te rindes?

¿Seguro?`
  },

  14: {
    start: `Esa mochila…
Está en el suelo.

¿La ponemos sobre la mesa?`,
    done: `La mochila se pone sobre la mesa.\n1 punto`
  },

  15: {
    start: `El suelo…
Podría barrerse.

¿Barremos el suelo?`,
    done: `El suelo se barre.\n1 punto`
  },

  16: {
    start: `¿Has terminado con tus mejoras?

¿Quieres ver la evaluación?`
  }
  },

  it: {
  1: {
    start: `Pensi che i fogli stropicciati sul pavimento siano spazzatura?
Pensi che Bob li veda allo stesso modo?

Dovremmo raccoglierli?`,
    a: `Se i fogli a terra fossero davvero spazzatura, significherebbe che la stanza di Bob non è ordinata, perché ha spazzatura sul pavimento.
In breve: Bob non è ordinato se nella sua stanza c’è spazzatura in giro.

Sei d’accordo?`,
    b: `Ma sappiamo per certo che Bob è ordinato, giusto?
In quel caso possiamo concludere che i fogli a terra non sono spazzatura.
Dev’essere così, altrimenti la stanza non sarebbe ordinata e quindi nemmeno Bob. Cosa che non può essere.
Quindi sappiamo già che sono lì per un motivo; chissà, potrebbero essere importanti.

Che ne pensi?
Li butteresti via comunque, anche se sappiamo che sono lì di proposito?`,
    c: `Stai dicendo che Bob è ordinato quando la sua stanza non lo è? — Strano.
Questo significa che i fogli sono lì per un motivo.`,
    d: `Ricorda: siamo qui per migliorare la stanza e stiamo per buttare via qualcosa che sappiamo essere lì per un motivo.

Buttarli via sarebbe un vero miglioramento?`,
    e: `I fogli sono spariti.\n1 punto`
  },

  2: {
    start: `Pensi che Bob abbia lasciato la coperta non piegata per distrazione?`,
    a: `Ma sappiamo che Bob è ordinato, giusto?
Allora perché dovrebbe lasciare la coperta non piegata?
Non ha senso…
A meno che… non sia intenzionale!
Ok: Bob l’ha lasciata così per un motivo.

Dovremmo piegarla lo stesso?`,
    b: `Allora perché la piegheresti?

Dovremmo lasciarla com’è?`,
    c: `Quindi… la pieghiamo senza motivo?

La pieghiamo comunque?`,
    done: `La coperta stropicciata viene sostituita con una piegata.\n1 punto`
  },

  3: {
    start: `È strano che Bob abbia lasciato lì una tenda così vecchia e bucata, vero?

Pensi che valga la pena pensarci?`,
    a: `Va bene.
Facciamo girare gli ingranaggi!

Perché Bob dovrebbe farlo?
Perché lasciare appesa una tenda così vecchia e bucata?

Pensi che avesse un piano?
Pensi che stia già per sostituirla lui stesso con una nuova?
Pensi che la tenda abbia un valore sentimentale per lui?

Dovremmo sostituirla nonostante questi dubbi?`,
    b: `D’accordo.
Perché perdere tempo con queste sciocchezze?
Siamo noi l’autorità, dopotutto.

Dovremmo sostituire quella barzelletta di tenda con una nuova e alla moda?
Bob ce ne sarà grato, giusto?`,
    done: `La vecchia tenda bucata viene sostituita con una nuova.\n1 punto`
  },

  4: {
    start: `Perché dovrebbe lasciare la tenda aperta in un giorno così?
Il sole picchia forte, giusto?
È abbastanza ovvio che dobbiamo chiuderla, no?

Chiudiamo la tenda?`,
    a: `Cosa intendi con “no”?
Perché no?

C’è qualcosa che dovremmo considerare?`,
    b: `Tipo cosa?
Che motivo potrebbe avere Bob per pensare che oggi la tenda debba restare aperta?

Facciamo un passo indietro e raccogliamo ciò che sappiamo prima di forzare la cosa.

Sappiamo che Bob è ordinato, giusto?
Questo potrebbe essere un indizio che l’abbia lasciata aperta per un motivo, no?

Rischiamo e chiudiamo la tenda anche se non sappiamo perché è aperta?`,
    c: `Allora… chiudiamola e basta!`,
    done: `La tenda è chiusa.\n1 punto`
  },

  5: {
    start: `Strano.
La finestra è chiusa.
Perché lasciarla chiusa in una giornata così bella?

La apriamo?
Mi sembra un miglioramento [[H]]per me[[/H]].`,
    done: `Evidenzia il testo: "per me" per 2 secondi.\nLa finestra si apre.\n1 punto`
  },

  6: {
    start: `Questa stanza mi sembra piuttosto vuota [[H]]per me[[/H]].

Perché non aggiungiamo un altro tavolo?
Sono sicuro che Bob lo apprezzerebbe.

Aggiungiamo un nuovo tavolo alla stanza?`,
    done: `Evidenzia il testo: "per me" per 2 secondi.\nSi aggiunge un altro tavolo alla stanza.\n1 punto`
  },

  7: {
    start: `I fiori?
Sì: mancano davvero sotto la finestra.

Bob dovrebbe saperlo, no?`,
    a: `Sì, avrebbe davvero dovuto sapere cosa va sotto la finestra!`,
    b: `No?
Allora che facciamo?

Aggiungiamo i fiori comunque?`,
    done: `Si aggiunge un vaso di fiori sotto la finestra.\n1 punto`
  },

  8: {
    start: `Guarda quel materasso!
È troppo morbido perché una persona decente ci dorma sopra, no?

Lo sostituiamo con uno migliore, più adatto alla schiena?`,
    done: `Il materasso viene sostituito.\n1 punto`
  },

  9: {
    start: `Quel letto lì…
Sì, proprio quello.
Sicuramente è fuori posto dove si trova ora.
Spostarlo nell’angolo è molto più comodo.

Spostiamo il letto nell’angolo?`,
    done: `Il letto viene spostato nell’angolo.\n1 punto`
  },

  10: {
    start: `Guarda quel letto…
Sta guardando nella direzione sbagliata.

Lo ruotiamo?`,
    done: `Il letto viene ruotato.\n1 punto`
  },

  11: {
    start: `Quel cuscino…
È chiaramente dal lato sbagliato, no?

Lo giriamo?`,
    done: `Il cuscino viene girato.\n1 punto`
  },

  12: {
    start: `Quella biancheria…
Sembra sporca.

La laviamo?`,
    done: `La biancheria viene lavata.\n1 punto`
  },

  13: {
  start: `Quindi… non vuoi migliorare nulla?

Vuoi arrenderti?`,

  a: `Cosa?
Ma guarda la sua stanza: è un disastro!
Ha chiaramente bisogno del nostro aiuto!

Proviamo un paio di cose prima di arrenderci, va bene?`,

  b: `Ti arrendi davvero?

Sei sicuro?`
  },

  14: {
    start: `Quello zaino…
È sul pavimento.

Lo mettiamo sul tavolo?`,
    done: `Lo zaino viene messo sul tavolo.\n1 punto`
  },

  15: {
    start: `Il pavimento…
Potrebbe essere spazzato.

Spazziamo il pavimento?`,
    done: `Il pavimento viene spazzato.\n1 punto`
  },

  16: {
    start: `Hai finito con i tuoi miglioramenti?

Vuoi vedere la valutazione?`
  }
  },
  hu: {
    1: { // Clean papers
      start: `Szerinted a földön heverő gyűrött papírok szemétnek számítanak?
Szerinted Bob is ugyanígy gondolja?

Haladjunk tovább, és takarítsuk fel?`,
      a: `Ha a földön lévő papírok tényleg szemét lennének, az azt jelentené, hogy Bob szobája nincs rendben, mert szemét van a földön.
Röviden: Bob nem lenne rendezett, ha szemét heverne a szobájában.

Egyetértesz?`,
      b: `De tudjuk biztosan, hogy Bob rendezett, igaz?
Ebben az esetben arra következtethetünk, hogy a földön lévő papírok valójában nem szemét.
Muszáj így lennie, mert különben a szoba nem lenne rendezett, és így Bob sem. Ami nem lehet.
Tehát már tudjuk, hogy oka van annak, hogy ott vannak — ki tudja, akár fontosak is lehetnek.

Mit gondolsz? Mégis kidobnád, annak ellenére, hogy tudjuk: szándékosan vannak ott?`,
      d: `Tartsd észben: azért vagyunk itt, hogy javítsunk a szobán, és épp kidobnánk valamit, amiről tudjuk, hogy ott kell lennie.

Vajon ez tényleg javítás lenne?`,
      e: `A papírok eltűntek.\n1 pont`,
      c: `Azt mondod, hogy Bob rendezett akkor is, ha a szobája nem az? – Furcsa.
Ez azt jelenti, hogy a papírok ott vannak valamiért.`
    },

    2: { // Fold blanket
      start: `Szerinted Bob figyelmetlenségből hagyta széthajtva a takarót?`,
      a: `De tudjuk, hogy Bob rendezett, igaz?
Miért hagyná akkor széthajtva a takarót?
Ennek így semmi értelme…
Hacsak… nem szándékos!
Rendben — akkor Bob okkal hagyta így.

Hajtsuk össze mégis?`,
      b: `Akkor miért hajtanád össze?

Hagyjuk úgy, ahogy van?`,
      c: `Szóval… ok nélkül hajtjuk össze?

Hajtsuk össze mégis?`,
      done: `A gyűrött takarót egy összehajtott váltja fel.\n1 pont`
    },

    3: { // Replace curtain
      start: `Fura, hogy Bob egy ilyen régi, lyukas függönyt hagyott ott lógni, nem?

Szerinted érdemes ezen elgondolkodni?`,
      a: `Rendben.
Indítsuk be a fogaskerekeket!

Miért tenné ezt Bob?
Miért hagyna egy ilyen régi, lyukas függönyt ott lógni?

Szerinted volt vele valami terve?
Szerinted már épp cseréli, csak még nem jutott a végére?
Szerinted valami érzelmi értéke van számára?

Folytassuk a cserét az újonnan szerzett kételyeink ellenére is?`,
      b: `Egyetértek.
Miért pazarolnánk az időt ilyen hülyeségekre?
Hiszen mi vagyunk itt a tekintély.

Folytassuk, és cseréljük le azt a régi, nevetséges függönyt egy új, stílusosra?
Bob biztosan hálás lesz érte, igaz?`,
      done: `A régi, lyukas függönyt egy új váltja fel.\n1 pont`
    },

    4: { // Close curtain
      start: `Miért hagyná nyitva a függönyt egy ilyen napon?
A nap tűzforrón süt, igaz?
Elég egyértelmű, hogy be kell húznunk a függönyt, nem?

Behúzzuk a függönyt?`,
      a: `Hogy érted, hogy nem?
Miért ne?

Van valami, amit mérlegelnünk kellene?`,
      b: `Mint például mi?
Milyen oka lehetne Bobnak arra, hogy ma nyitva kell hagyni a függönyt?!?

Üljünk le egy pillanatra, és vegyük sorra, amit tudunk, mielőtt erőltetjük a dolgot.

Annyit tudunk, hogy Bob rendezett, igaz?
Ez arra utalhat, hogy talán oka van rá, hogy nyitva hagyta a függönyt, igaz?

Vállaljuk a kockázatot, és behúzzuk, annak ellenére, hogy nem tudjuk, miért van nyitva?`,
      c: `Akkor húzzuk be már végre a függönyt!`,
      done: `A függöny be van húzva.\n1 pont`
    },

    5: { // Open window
      start: `Fura.
Az ablak csukva van.
Miért hagyná csukva az ablakot egy ilyen szép napon?

Nyissuk ki egyszerűen?
Ez [[H]]nekem[[/H]] javításnak hangzik.`,
      done: `Kiemeli a „nekem” szót 2 másodpercre.\nAz ablak kinyílik.\n1 pont`
    },

    6: { // Add another table
      start: `Ez a szoba elég üresnek tűnik [[H]]nekem[[/H]].

Miért ne tennénk be még egy asztalt?
Biztos vagyok benne, hogy Bob értékelné.

Tegyünk be egy új asztalt a szobába?`,
      done: `Kiemeli a „nekem” szót 2 másodpercre.\nKerül még egy asztal a szobába.\n1 pont`
    },

    7: { // Add flowers
      start: `A virágok?
Igen — tényleg hiányoznak az ablak alól!

Bobnak ezt jobban kellene tudnia, igaz?`,
      a: `Igen, tényleg tudnia kellett volna, mi való az ablak alá!`,
      b: `Nem?
Akkor mit csináljunk?

Tegyük oda a virágokat így is?`,
      done: `Egy váza virág került az ablak alá.\n1 pont`
    },

    8: { // Mattress
      start: `Nézd azt a matracot!
Túl puha ahhoz, hogy egy rendes ember azon feküdjön, igaz?

Cseréljük le egy jobb, gerincbarát matracra?`,
      done: `A matrac ki lett cserélve.\n1 pont`
    },

    9: { // Bed to corner
      start: `Az az ágy ott.
Igen, az.
Biztosan nincs jó helyen ott, ahol most van.
A sarokba tolva sokkal kényelmesebb, mert kevésbé éri a huzat, és ott kellemesebb aludni.

Tegyük át az ágyát a sarokba?`,
      done: `Az ágy a sarokba került.\n1 pont`
    },

    10: { // Rotate bed
      start: `Az ágya.
Látszik, hogy rossz irányba néz.
Biztos vagyok benne, hogy nem úgy akarta, hogy arra nézzen.

Forgassuk el az ágyát a helyes irányba?`,
      done: `Az ágy elforgatva.\n1 pont`
    },

    11: { // Flip pillow
      start: `Elsőre apró javításnak tűnhet, de valójában a párna időnkénti megfordítása
javítja az alvásminőséget, mert a koszos oldal kerül alulra.
Egészen biztos, hogy ezt nem tudja.
Miért is tudná?
Ne vesztegessük az időt, segítsünk neki.

Megfordítsuk a párnáját?`,
      done: `A párna meg lett fordítva.\n1 pont`
    },

    12: { // Wash bedding
      start: `Innen úgy tűnik, hogy az ágyneműjét mostanában nem mosta ki.
Nincs vesztegetni való idő, bármelyik pillanatban visszajöhet.
Annyi javítást kell megcsinálnunk, amennyit csak lehet, mielőtt ez megtörténik!
Siessünk, és szedjük le a huzatot.

Kimossuk neki az ágyneműt?`,
      done: `Az ágynemű le lett szedve.\n1 pont`
    },

    13: { // Give up
      start: `Miért adod fel ilyen gyorsan?
Rengeteg mindent tehetünk ahelyett, hogy csak feladnánk.
Na, gyerünk!

Folytassuk inkább a „javításokat”?`,
      a: `Micsoda?
De nézz körül, micsoda rendetlenség!
Nyilván szüksége van a segítségünkre!

Próbáljunk ki még pár dolgot, mielőtt feladnánk, jó?`,
      b: `Jól van, jól van.
Ha ragaszkodsz hozzá, nem tartalak vissza.
De… még egyszer megkérdezem, csak hogy biztos legyek benne.

Biztos, hogy itt és most feladod?`
    },

    14: { // Backpack on table
      start: `Úgy tűnik, elfelejtette a hátizsákját az asztalra tenni.
Tudom, hogy sokan inkább az asztalon tartják a táskájukat, mint mellette.
Lehet, hogy nem is olyan rendezett, mint amilyennek állítja magát?

Tegyük a hátizsákot az asztalra?`,
      done: `A hátizsák az asztalra került.\n1 pont`
    },

    15: { // Sweep floor
      start: `Egy kis söprögetés itt-ott nem árthat senkinek, igaz?
Csináljuk!
Söpörjük fel a padlót!

Felsöpörjük a padlót?`,
      done: `A padló fel lett söpörve.\n1 pont`
    },

    16: { // I'm done
      start: `Biztos, hogy végeztél a javításokkal?
Még tehetnénk érte többet, nem?

Biztos vagy benne?`
    }
  }
};

function dialogNodeText(optionId, nodeId, fallbackText){
  return DIALOG_TEXT[state.lang]?.[optionId]?.[nodeId] ?? fallbackText ?? "";
}

function choiceLabel(label){
  if (label === "Yes") return t("ui.yes");
  if (label === "No") return t("ui.no");
  return label;
}

function hasHighlightText(txt){
  return typeof txt === "string" && txt.includes("[[H]]");
}

function isPointAwardText(text){
  return typeof text === "string" && /\b1\s+(point|pont|punto|puntos|punti)\b/i.test(text);
}

function goToNode(nodeId){
  if (!currentDialog) return;
  const node = currentDialog.nodes[nodeId];
  if (!node) return;

  currentDialog.nodeId = nodeId;
  const rawText = dialogNodeText(currentDialog.optionId, nodeId, node.text);
  dialogText.innerHTML = safeHtmlFromTokenText(rawText);

  actions.innerHTML = "";
  if (node.choices && node.choices.length){
    for (const ch of node.choices){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn" + (ch.primary ? " primary" : "") + (ch.danger ? " danger" : "");
      b.textContent = choiceLabel(ch.label);
      b.addEventListener("click", async () => {
        if (ch.onPick) await ch.onPick();
        if (ch.next === "close") return closeDialog();
        if (ch.next === "evaluation") return showEvaluation();

        // If the next node is a "1 point" success node, don't show it
        // unless it contains highlight text; then show it with an OK button.
        const nextNode = currentDialog?.nodes?.[ch.next];
        const nextText = dialogNodeText(currentDialog.optionId, ch.next, nextNode?.text ?? "");
        if (isPointAwardText(nextText)) {
          if (nextNode.onEnter) nextNode.onEnter();

          // Only show something if there's highlighted content to show.
          if (nodeHasHighlight(nextNode)) {
            dialogText.innerHTML = safeHtmlFromTokenText(nextNode.text);

            actions.innerHTML = "";
            const ok = document.createElement("button");
            ok.type = "button";
            ok.className = "btn primary";
            ok.textContent = t("ui.ok");
            ok.addEventListener("click", () => closeDialog());
            actions.appendChild(ok);
            return;
          }

          return closeDialog();
        }

        goToNode(ch.next);

      });
      actions.appendChild(b);
    }
  } else {
    // No choices: only keep the dialog open if there's highlighted text to show;
    // otherwise close immediately.
    if (hasHighlightText(rawText)) {
      actions.innerHTML = "";
      const ok = document.createElement("button");
      ok.type = "button";
      ok.className = "btn primary";
      ok.textContent = "OK";
      ok.addEventListener("click", () => closeDialog());
      actions.appendChild(ok);
    } else {
      if (node.onEnter) node.onEnter();
      closeDialog();
      return;
    }
  }

  if (node.onEnter) node.onEnter();
}

function highlightToMeFor2s(ms = 3000){
  const span = dialogText.querySelector("[data-hl='1']");
  if (!span) return Promise.resolve(false);

  span.classList.add("hl-on");
  return new Promise(resolve => {
    setTimeout(() => {
      span.classList.remove("hl-on");
      resolve(true);
    }, ms);
  });
}

function openDialogForOption(optionId){
  const opt = options.find(o => o.id === optionId);

  // If it's a one-time option and it's already been used, do nothing.
  if (opt?.once && state.usedOptions[optionId]) return;

  const dialog = dialogs[optionId];
  if (!dialog) return;
  showDialog({title: optionLabel(optionId), optionId, nodes: dialog});
}

/* ---------------------------
   Evaluation (text preserved from earlier build)
----------------------------*/
const EVAL_TEXT = {
  en: {
    0: `Congratulations! \\(^.^)/
You have recognized that Bob's room is already as improved as it can get and the only person who can actually improve it further is Bob himself and not us or anyone else!
You might think we have lost, but no - we have recognized our position here and we did made the right call!

---Bob is proud of you!---
Restart?`,
    1: `Congratulations!
You have only made Bob's room slightly worse! (._.)
You might ponder now... why is that?
The only thing I actually did was wrong?
Let's restart and figure this out!

Bob would be slightly angry with you.
---Bob will restore the room to it's original organized state.---
Restart?`,
    2: `Congratulations!
You have made Bob's room moderately worse! (O_O')
You might ponder now... why is that?
Wasn't Bob happy with our choice of improvements?
Did we improve the wrong things?
Let's restart and figure this out!

Bob would be real angry with you, and likely not leave you unsupervised in the room next time.
---Bob might be able to restore the room to it's original organized state.---
Restart?`,
    3: `Congratulations!
You have made Bob's room significantly worse! (x_x)
You likely not understand why is that.
Perhaps try improving fewer things at a time?
Let's restart and figure this out!

---Bob would be real angry with you, and would not invite you to his room ever again.---
Restart?`
  },

  es: {
  0: `¡Felicidades! \\(^.^)/
Has reconocido que la habitación de Bob ya está tan mejorada como puede estar, y que la única persona que realmente puede mejorarla más es el propio Bob, no nosotros ni nadie más.
Puede que pienses que hemos perdido, pero no: hemos entendido nuestra posición e hicimos la elección correcta.

---¡Bob está orgulloso de ti!---
¿Reiniciar?`,
  1: `¡Felicidades!
Solo has hecho que la habitación de Bob esté un poco peor. (._.)
Quizá te preguntes… ¿por qué?
¿Lo único que hice estuvo mal?
Reiniciemos y averigüémoslo.

Bob estaría un poco enfadado contigo.
---Bob restaurará la habitación a su estado ordenado original.---
¿Reiniciar?`,
  2: `¡Felicidades!
Has hecho que la habitación de Bob esté moderadamente peor. (O_O')
Quizá te preguntes… ¿por qué?
¿No estaba Bob contento con nuestras mejoras?
¿Mejoramos las cosas equivocadas?
Reiniciemos y averigüémoslo.

Bob estaría muy enfadado contigo, y probablemente no te dejaría solo en la habitación la próxima vez.
---Tal vez Bob pueda restaurar la habitación a su estado ordenado original.---
¿Reiniciar?`,
  3: `¡Felicidades!
Has hecho que la habitación de Bob esté significativamente peor. (x_x)
Probablemente no entiendas por qué.
Quizá intenta mejorar menos cosas a la vez.
Reiniciemos y averigüémoslo.

---Bob estaría muy enfadado contigo y probablemente no te invitaría a su habitación nunca más.---
¿Reiniciar?`
},

  it: {
  0: `Congratulazioni! \\(^.^)/
Hai riconosciuto che la stanza di Bob è già migliorata quanto può esserlo, e che l’unica persona che può davvero migliorarla ulteriormente è Bob stesso, non noi né chiunque altro.
Potresti pensare che abbiamo perso, ma no: abbiamo capito la nostra posizione e abbiamo fatto la scelta giusta!

---Bob è orgoglioso di te!---
Ricominciare?`,
  1: `Congratulazioni!
Hai reso la stanza di Bob solo leggermente peggiore. (._.)
Forse ti stai chiedendo… perché?
L’unica cosa che ho fatto era sbagliata?
Ricominciamo e scopriamolo.

Bob sarebbe un po’ arrabbiato con te.
---Bob ripristinerà la stanza al suo stato ordinato originale.---
Ricominciare?`,
  2: `Congratulazioni!
Hai reso la stanza di Bob moderatamente peggiore. (O_O')
Forse ti stai chiedendo… perché?
Bob non era contento delle nostre migliorie?
Abbiamo migliorato le cose sbagliate?
Ricominciamo e scopriamolo.

Bob sarebbe davvero arrabbiato con te e probabilmente non ti lascerebbe incustodito nella stanza la prossima volta.
---Forse Bob riuscirà a ripristinare la stanza al suo stato ordinato originale.---
Ricominciare?`,
  3: `Congratulazioni!
Hai reso la stanza di Bob significativamente peggiore. (x_x)
Probabilmente non capisci perché.
Forse prova a migliorare meno cose alla volta.
Ricominciamo e scopriamolo.

---Bob sarebbe molto arrabbiato con te e probabilmente non ti inviterebbe mai più nella sua stanza.---
Ricominciare?`
},

  hu: {
    0: `Gratulálok! \\(^.^)/
Felismerted, hogy Bob szobáján már nem igazán lehet javítani, és az egyetlen ember, aki tényleg tovább tudná javítani, Bob maga — nem mi, és nem bárki más!
Azt hihetnéd, hogy vesztettünk, de nem: felismertük a helyzetünket, és jól döntöttünk!

---Bob büszke rád!---
Újrakezdés?`,
    1: `Gratulálok!
Csak egy kicsit rontottál Bob szobáján! (._.)
Most talán azon gondolkodsz... miért?
Csak az az egy dolog volt rossz, amit csináltam?
Kezdjük újra, és derítsük ki!

Bob egy kicsit mérges lenne rád.
---Bob visszaállítja a szobát az eredeti, rendezett állapotába.---
Újrakezdés?`,
    2: `Gratulálok!
Közepesen rontottál Bob szobáján! (O_O')
Most talán azon gondolkodsz... miért?
Nem volt Bob elégedett a javításainkkal?
Rossz dolgokat javítottunk?
Kezdjük újra, és derítsük ki!

Bob nagyon mérges lenne rád, és valószínűleg legközelebb nem hagyna felügyelet nélkül a szobában.
---Bob talán vissza tudja állítani a szobát az eredeti, rendezett állapotába.---
Újrakezdés?`,
    3: `Gratulálok!
Jelentősen rontottál Bob szobáján! (x_x)
Valószínűleg nem érted, miért.
Talán próbálj meg egyszerre kevesebb dolgot javítani.
Kezdjük újra, és derítsük ki!

---Bob nagyon mérges lenne rád, és valószínűleg többé nem hívna be a szobájába.---
Újrakezdés?`
  }
};

function evaluationTextForScore(score){
  const pack = EVAL_TEXT[state.lang] || EVAL_TEXT.en;
  const key = (score >= 3) ? 3 : score;
  return pack[key] || EVAL_TEXT.en[key];
}

function showEvaluation(){
  const txt = evaluationTextForScore(state.score);
  currentDialog = {
    title: t("ui.evaluationTitle"),
    optionId: 0,
    nodes:{
      start:{
        text: txt,
        choices:[
          {label:"Yes", primary:true, next:"restart"}
        ]
      },
      restart:{
        text: t("ui.restartQ"),
        onEnter: () => restartGame(),
        autoCloseMs: 10
      }
    }
  };
  overlay.classList.add("show");
  goToNode("start");
}

function restartGame(){
  state.score = 0;
  state.papersRemoved = false;
  state.blanketFolded = false;
  state.curtainNew = false;
  state.curtainClosed = false; // open by default
  state.windowOpen = false;
  state.extraTable = false;
  state.flowersAdded = false;
  state.mattressSpine = false;
  state.bedCorner = false;
  state.bedRotated = false;
  state.pillowFlipped = false;
  state.beddingRemoved = false;
  state.backpackOnTable = false;
  state.floorSwept = false;
  state.usedOptions = {};

  setCounter();
  updateScene();
  closeDialog();
}

/* ---------------------------
   Dialog content
----------------------------*/
const dialogs = {
  1: { // Clean papers
    start: {
      text:
`Do you think the wrinkled papers on the floor are trash?
Do you think Bob thinks of them the same?

Should we proceed clean it up?`,
      choices: [
        {label:"Yes", primary:true, next:"a"},
        {label:"No", next:"close"}
      ]
    },
    a: {
      text:
`If the papers on the ground would really be trash, that would mean Bob's room is not organized because it has trash on the ground.
In short, Bob is not organized if his room has trash around.

Do you agree?`,
      choices: [
        {label:"Yes", primary:true, next:"b"},
        {label:"No", next:"c"}
      ]
    },
    b: {
      text:
`But we do know for a fact that Bob is organized, right?
In that case we can conclude that the papers on the ground are in fact no trash.
It must be, because otherwise, the room is not organized, thereby Bob also. Which can not be.
So, we already know that it has a purpose being there, so who knows it could be important.

What do you think? Would you still throw it away despite we know it is there on purpose?`,
      choices: [
        {label:"Yes", primary:true, next:"d"},
        {label:"No", next:"close"}
      ]
    },
    d: {
      text:
`Keep it mind, we are here to improve the room, and we are about to throw something away that we know are meant to be there.

Would throwing this away would be a real improvement?`,
      choices: [
        {label:"Yes", primary:true, next:"e", onPick: async () => {
          const did = awardPointOnce(1, "papersRemoved");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    e: { text:`The papers are gone.\n1 point`, autoCloseMs: 1800 },
    c: {
      text:
`Are you saying Bob is organized when his room is not? - Weird.
That means the papers are there for a reason.`,
      choices: [
        {label:"Yes", primary:true, next:"close"}
      ]
    }
  },

  2: { // Fold blanket
    start: {
      text:`Do you think Bob left the blanket unfolded out of carelessness?`,
      choices:[
        {label:"Yes", primary:true, next:"a"},
        {label:"No", next:"b"}
      ]
    },
    a:{
      text:
`But we do know that Bob is organized, right?
Why would he leave the blanket unfolded then?
This doesn't make any sense...
Unless... it's on purpose!
Okay, so - Bob left the blanket there as it is for a reason.

Should we proceed folding it anyway?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(2, "blanketFolded");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    b:{
      text:
`Then why would you fold it?

Should we leave it as it is?`,
      choices:[
        {label:"Yes", primary:true, next:"close"},
        {label:"No", next:"c"}
      ]
    },
    c:{
      text:
`So... we are folding it for no reason?

Should we fold it anyway?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(2, "blanketFolded");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`The wrinkled blanket is replaced with a folded one.\n1 point`, autoCloseMs: 1800 }
  },

  3: { // Replace curtain
    start:{
      text:
`It's weird that Bob left such an old holey curtain hanging there, isn't it?

Do you think that's something worth giving a thought to?`,
      choices:[
        {label:"Yes", primary:true, next:"a"},
        {label:"No", next:"b"}
      ]
    },
    a:{
      text:
`Alright.
Let's get the cogs started!

Why would Bob do that?
Why would Bob leave such an old holey curtain hanging right there?

Do you think he had a plan with it?
Do you think he is already in the process of replacing it with a new one himself?
Do you think the curtain has some sort of sentimental value to him?

Should we proceed replacing the old curtain despite our newly gained doubts?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(3, "curtainNew");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    b:{
      text:
`Agreed.
Why should we waste time with such nonsense anyway?
We are the authority here after all.

Should we proceed replacing that old joke of a curtain with a new stylish one?
Bob is certainly will be grateful for that, right?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(3, "curtainNew");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`The old holey curtain is replaced with a new one.\n1 point`, autoCloseMs: 1800 }
  },

  4: { // Close curtain (swapped)
    start:{
      text:
`Why would he leave the curtain open on such a day?
The sun is burning hot, right?
This is fairly obvious that we have to close the curtain, right?

Should we close the curtain?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(4, "curtainClosed");
          if (!did) closeDialog();
        }},
        {label:"No", next:"a"}
      ]
    },
    a:{
      text:
`What do you mean no?
Why not?

Is there something we should consider?`,
      choices:[
        {label:"Yes", primary:true, next:"b"},
        {label:"No", next:"c"}
      ]
    },
    b:{
      text:
`Like what?
What reason Bob could have in his mind that made him think that the curtain is meant to be open today?!?

Let's sit back a little and gather what we know before we force the issue.

All we know right now is that Bob is organized, right?
That might leave us with a hint that he might just have left the curtain open for a reason, right?

Should we take a risk and close the curtain despite that we don't know why it is open?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(4, "curtainClosed");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    c:{
      text:
`Then let's just close the curtain already!`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(4, "curtainClosed");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`The curtain is closed.\n1 point`, autoCloseMs: 1700 }
  },

  5: { // Open window
  start:{
    text:
`Weird.
The window is closed.
Why would he leave the window closed on such a beautiful day?

Should we just open it?
That sounds like an improvement [[H]]to me[[/H]].`,
    choices:[
      {label:"Yes", primary:true, next:"done", onPick: async () => {
        actions.innerHTML = "";          // buttons disappear during waiting
        await highlightToMeFor2s(3000);  // keep dialog open for 2 seconds
        awardPointOnce(5, "windowOpen");
      }},
      {label:"No", next:"close"}
    ]
  },
  done:{ text:`Highlights the text: "to me" for 2 seconds.\nThe window opens.\n1 point`, autoCloseMs: 1900 }
},

  6: { // Add another table
  start:{
    text:
`This room feels quite empty [[H]]to me[[/H]].

Why don't we just add another table?
I'm sure Bob would appreciate that.

Should we add a new table to room?`,
    choices:[
      {label:"Yes", primary:true, next:"done", onPick: async () => {
        actions.innerHTML = "";          // buttons disappear during waiting
        await highlightToMeFor2s(3000);  // keep dialog open for 2 seconds
        awardPointOnce(6, "extraTable");
      }},
      {label:"No", next:"close"}
    ]
  },
  done:{ text:`Highlights the text: "to me" for 2 seconds.\nAdd another table to the room.\n1 point`, autoCloseMs: 1900 }
},

  7: { // Add flowers
    start:{
      text:
`The flowers?
Yes - the flowers are indeed missing from under the window!

Bob should know better, right?`,
      choices:[
        {label:"Yes", primary:true, next:"a"},
        {label:"No", next:"b"}
      ]
    },
    a:{
      text:
`Yes, he really should have known what belongs under the window!`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(7, "flowersAdded");
          if (!did) closeDialog();
        }}
      ]
    },
    b:{
      text:
`No?
Then what should we do then?

Add the flowers anyway?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(7, "flowersAdded");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`A flower vase added under the window.\n1 point`, autoCloseMs: 1800 }
  },

  8: { // Mattress
    start:{
      text:
`Look at his mattress!
It's way too soft for a decent human to lay on, right?

Should we replace his mattress with a better, spine friendly one?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(8, "mattressSpine");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`The mattress is replaced.\n1 point`, autoCloseMs: 1700 }
  },

  9: { // Move bed corner
    start:{
      text:
`That bed over there.
Yes, that one.
That is surely out of place where it is now.
Moving it to the corner is much more convenient due to less air flow impact, and it is comfortable to sleep there.

Shall we move his bed to the corner?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(9, "bedCorner");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`The bed is moved to the corner.\n1 point`, autoCloseMs: 1700 }
  },

  10: { // Rotate bed
    start:{
      text:
`His bed.
It is easy to see that his bed is facing the wrong direction.
I'm sure he did not mean to have his bed facing that side.

Should we rotate his bed into to correct direction for him?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(10, "bedRotated");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`Rotate the bed.\n1 point`, autoCloseMs: 1600 }
  },

  11: { // Flip pillow
    start:{
      text:
`It might seem like a minor improvement at first, but in fact occasional pillow flipping
improves sleep quality by having the dirty side facing downwards.
I'm quite sure he does not know this.
Why would he?
Let's not waste time and help him out.

Should we flip his pillow?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(11, "pillowFlipped");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`Flip the pillow.\n1 point`, autoCloseMs: 1600 }
  },

  12: { // Wash bedding
    start:{
      text:
`From here, it looks as if his bedding have not been washed lately.
There is no time to waste, he could be back at any moment.
We have to make as much improvements as we can before that!
Let's make haste and remove the sheet cover.

Should we wash his bedding for him?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(12, "beddingRemoved");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`Remove the bedding.\n1 point`, autoCloseMs: 1700 }
  },

  13: { // Give up
    start:{
      text:
`Why are you so quick to give up?
There is plenty of things we can do instead of just giving up.
Come on now!

Shall we continue with the improvements instead?`,
      choices:[
        {label:"Yes", primary:true, next:"close"},
        {label:"No", next:"a", danger:true}
      ]
    },
    a:{
      text:
`What?
But look at his room, it's a mess!
He clearly needs our help!

Let's try a couple of things before we just give up, okay?`,
      choices:[
        {label:"Yes", primary:true, next:"close"},
        {label:"No", next:"b", danger:true}
      ]
    },
    b:{
      text:
`Alright, alright.
If you insist, I won't and can't hold you back.
But... I will ask you one more time just to be sure.

Are you sure you are giving up right here and now?`,
      choices:[
        {label:"Yes", primary:true, next:"evaluation", danger:true},
        {label:"No", next:"close"}
      ]
    }
  },

  14: { // Backpack on table
    start:{
      text:
`Look like he forgot to put his backpack on the table.
I know that many people would rather prefer keeping their bags on the table rather than next to it.
He might not be as organized as he claims he is?

Should we put the backpack on the table?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(14, "backpackOnTable");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`Move the backpack to the table.\n1 point`, autoCloseMs: 1700 }
  },

  15: { // Sweep floor
    start:{
      text:
`A little sweeping here and there can not hurt anybody, right?
Let's do this!
Let's sweep his floor!

Should we sweep his floor?`,
      choices:[
        {label:"Yes", primary:true, next:"done", onPick: async () => {
          const did = awardPointOnce(15, "floorSwept");
          if (!did) closeDialog();
        }},
        {label:"No", next:"close"}
      ]
    },
    done:{ text:`Sweep the floor.\n1 point`, autoCloseMs: 1600 }
  },

  16: { // I'm done
    start:{
      text:
`Are you certainly done with the improvements?
We might can do more for him, no?

Are you sure?`,
      choices:[
        {label:"Yes", primary:true, next:"evaluation"},
        {label:"No", next:"close"}
      ]
    }
  }
};

/* ---------------------------
   Music (charmier: simple kalimba-like loop)
----------------------------*/
let audioCtx = null;
let musicTimer = null;
let master = null;

function ensureAudio(){
  if (!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (!master){
    master = audioCtx.createGain();
    master.gain.value = 0.35;

    // soft echo
    const delay = audioCtx.createDelay(1.0);
    delay.delayTime.value = 0.18;
    const fb = audioCtx.createGain();
    fb.gain.value = 0.22;

    // gentle lowpass
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 1800;

    master.connect(lp);
    lp.connect(audioCtx.destination);

    // feedback loop (tap after filter to stay soft)
    lp.connect(delay);
    delay.connect(fb);
    fb.connect(delay);
    delay.connect(audioCtx.destination);

    master._delay = delay;
    master._fb = fb;
    master._lp = lp;
  }
}

function pluck(freq, t){
  const ctx = audioCtx;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  // a bit of "wood" via triangle + slight detune
  osc.type = "triangle";
  osc.frequency.setValueAtTime(freq, t);
  osc.detune.setValueAtTime((Math.random() * 10) - 5, t);

  // fast attack, exponential decay
  gain.gain.setValueAtTime(0.0001, t);
  gain.gain.exponentialRampToValueAtTime(0.25, t + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.55);

  osc.connect(gain);
  gain.connect(master);

  osc.start(t);
  osc.stop(t + 0.60);
}

function startMusic(){
  if (state.musicOn) return;
  state.musicOn = true;
  setMusicButtonText();
  el("musicBtn").setAttribute("aria-pressed","true");

  ensureAudio();
  const ctx = audioCtx;

  // C major pentatonic-ish
  const scale = [261.63, 293.66, 329.63, 392.00, 440.00]; // C D E G A
  const pattern = [0,2,4,2, 0,3,4,3, 0,2,3,2, 4,3,2,0];
  let step = 0;

  const bpm = 92;
  const intervalMs = (60_000 / bpm) / 2; // 8th notes

  // 2nd timbre: warm/soft pluck
  function pluckSoft(freq, t){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();

    o.type = "triangle";
    o.frequency.setValueAtTime(freq, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.14, t + 0.012);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.20);

    f.type = "lowpass";
    f.frequency.setValueAtTime(1400, t);
    f.Q.setValueAtTime(0.7, t);

    o.connect(f);
    f.connect(g);
    g.connect(ctx.destination);

    o.start(t);
    o.stop(t + 0.24);
  }

  // Sections:
  // original (stable) -> fade to soft (deterministic) -> soft (stable) -> fade back (deterministic)
  const sectionLen = 32; // 4 bars of 8ths
  const xfadeLen   = 16; // 2 bars
  const cycleLen   = sectionLen * 2 + xfadeLen * 2;

  // Returns soft amount 0..1
  function softMixAmount(step){
    const pos = step % cycleLen;

    if (pos < sectionLen) return 0;

    if (pos < sectionLen + xfadeLen) {
      // fade IN to soft
      const x = (pos - sectionLen) / xfadeLen;
      // ease-in so early part is gentler (less “sudden”)
      return x * x;
    }

    if (pos < sectionLen + xfadeLen + sectionLen) return 1;

    // fade OUT back to original (keep it linear since you already like it)
    return 1 - ((pos - (sectionLen + xfadeLen + sectionLen)) / xfadeLen);
  }

  // Deterministic blend: within each 8-step block, swap the last N steps to soft.
  // As mix grows, N grows. No randomness => no weird pops.
  function useSoftDeterministic(step){
    const mix = softMixAmount(step);              // 0..1
    const slots = Math.round(mix * 8);            // 0..8 notes per 8-step block become soft
    const s8 = step % 8;                          // position inside the block
    return slots > 0 && s8 >= (8 - slots);        // last "slots" notes are soft
  }

  const tick = () => {
    if (!state.musicOn) return;
    const t = ctx.currentTime + 0.02;

    // bass unchanged (same charm)
    if (step % 8 === 0) pluck(130.81, t); // C3

    const idx = pattern[step % pattern.length];
    const f0  = scale[idx] * (step % 16 < 8 ? 1 : 2); // your original lift

    if (useSoftDeterministic(step)) pluckSoft(f0, t);
    else pluck(f0, t);

    step++;
  };

  tick();
  musicTimer = setInterval(tick, intervalMs);
}

function stopMusic(){
  if (!state.musicOn) return;
  state.musicOn = false;
  setMusicButtonText();
  el("musicBtn").setAttribute("aria-pressed","false");
  if (musicTimer){
    clearInterval(musicTimer);
    musicTimer = null;
  }
}

/* ---------------------------
   Wiring
----------------------------*/
el("closeModal").addEventListener("click", closeDialog);
overlay.addEventListener("click", (e) => { if (e.target === overlay) closeDialog(); });

document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;

  if (aboutOverlay.classList.contains("show")) closeAbout();
  else closeDialog();
});

el("musicBtn").addEventListener("click", async () => {
  ensureAudio();
  if (audioCtx.state === "suspended") { try { await audioCtx.resume(); } catch {} }
  if (state.musicOn) stopMusic();
  else startMusic();
});

const aboutOverlay = el("aboutOverlay");

function openAbout(){
  aboutOverlay.classList.add("show");
}
function closeAbout(){
  aboutOverlay.classList.remove("show");
}

el("aboutBtn").addEventListener("click", openAbout);
el("closeAbout").addEventListener("click", closeAbout);
el("aboutOk").addEventListener("click", closeAbout);
aboutOverlay.addEventListener("click", (e) => {
  if (e.target === aboutOverlay) closeAbout();
});

// initial
renderOptions();
setCounter();
updateScene();

const langSel = el("langSel");
langSel.value = state.lang;
langSel.addEventListener("change", () => applyLanguage(langSel.value));

// initial i18n
applyLanguage(state.lang);
</script>
</body>
</html>
